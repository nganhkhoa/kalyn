module Main where

import           Data.ByteString.Builder
import qualified Data.ByteString.Lazy          as B
import           System.Posix.Files

import qualified ELF

helloWorld :: B.ByteString
helloWorld = B.pack
  [ 0x48 -- mov $0x1, %rax
  , 0xc7
  , 0xc0
  , 0x01
  , 0x00
  , 0x00
  , 0x00
  , 0x48 -- mov $1, %rdi
  , 0xc7
  , 0xc7
  , 0x01
  , 0x00
  , 0x00
  , 0x00
  , 0x48 -- lea 28(%rip), %rsi
  , 0x8d
  , 0x35
  , 0x1c
  , 0x00
  , 0x00
  , 0x00
  , 0x48 -- mov $14, %rdx
  , 0xc7
  , 0xc2
  , 0x0e
  , 0x00
  , 0x00
  , 0x00
  , 0x0f -- syscall
  , 0x05
  , 0x48 -- mov $0x3c, %rax
  , 0xc7
  , 0xc0
  , 0x3c
  , 0x00
  , 0x00
  , 0x00
  , 0x48 -- xor %rdi, %rdi
  , 0x31
  , 0xff
  , 0x0f -- syscall
  , 0x05
  , 0x48 -- "Hello, world!\n"
  , 0x65
  , 0x6c
  , 0x6c
  , 0x6f
  , 0x2c
  , 0x20
  , 0x77
  , 0x6f
  , 0x72
  , 0x6c
  , 0x64
  , 0x21
  , 0x0d
  , 0x0a
  ]

main :: IO ()
main = do
  B.writeFile "main" (ELF.elfData helloWorld)
  setFileMode "main" 0o777
